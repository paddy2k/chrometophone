<!doctype html>
<html>
<head>
<script type="text/javascript" src="constants.js"></script>
<script type="text/javascript" src="send_logic.js"></script>
<script>

var UIItemProperties = { // options for the button
   disabled: false,
   title: "Opera to Phone",
   icon: "icon.png",
   popup: {
      href: 'popup.html',
      width: "320px",
      height: "60px"
   }
}
var operaBtn = opera.contexts.toolbar.createItem( UIItemProperties ); // create the button
opera.contexts.toolbar.addItem( operaBtn ); // add button to UI

var currentTab = null; // tracks currently focused tab

opera.extension.addEventListener('message', function(request) { onMessage(request); }, false);

var currentUserJS = null; // keeps track of which UserJS is in focus
var timoutTimer = null;

function onMessage(request) {

      if (request.data.action==ACTION_REGISTER_USERJS) {
          
         currentUserJS = request.data.uuid;
         //opera.postError("BG: Registered UserJS[" + currentUserJS + "]");
         
      } else if (request.data.action==ACTION_DEREGISTER_USERJS) {

    	  // deregister after a short delay, so the button has time to capture the currentUserJS
          window.setTimeout(function() {
           if(currentUserJS==request.data.uuid) {
               //opera.postError("BG: Deregistering UserJS[" + currentUserJS + "]");
               currentUserJS = null;
           }
          }, 300);
          
      } else if(request.data.action==ACTION_START_SEND) {
          
        var captureSelection = {
                action: ACTION_CAPTURE_SELECTION,
                uuid: currentUserJS
        };

        // Get the selected text (if any) from the UserJS
        opera.extension.broadcastMessage(captureSelection);

        // Set timeoutTimer to throw an error after 1 second...     
        timeoutTimer = window.setTimeout(function() {
           request.data.action = ACTION_SEND_PAGE;
     	   onMessage(request); // stop waiting for UserJS and go to next step
        }, 1000);
            
      } else if (request.data.action==ACTION_SEND_PAGE) {

         // Cancel timeoutTimer        
         if(timeoutTimer) window.clearTimeout(timeoutTimer);

         var userJS_data = {};
         if(request.data.data) userJS_data = request.data.data;

         // Set currentTab pointer
         currentTab = opera.extension.tabs.getFocused();
         
         if(currentTab || userJS_data.link) {

            var url = userJS_data.link ? userJS_data.link : encodeURIComponent(currentTab.url);
            var title = userJS_data.title ? userJS_data.title : encodeURIComponent(currentTab.title);
            var sel = userJS_data.selection ? userJS_data.selection : '';
            var msgType = (sel && sel.length > 0) ? 'selection' : 'page';

            var urlCheck = decodeURIComponent(url);
            if (urlCheck.indexOf('http:') == 0 || urlCheck.indexOf('https:') == 0) {
               sendToPhone(title, url, sel, msgType, function(status) {
                   // Display sendToPhone result in popup.html
                   opera.extension.broadcastMessage({action: status});
               });
            } else {
               opera.extension.broadcastMessage({action: STATUS_NO_TAB_ACCESS});
            }
            
         } else { // no object means that the extension does not have access to the current tab :(

            opera.extension.broadcastMessage({action: STATUS_NO_TAB_ACCESS});
            
         }

         // Reset currentTab pointer
         currentTab = null; 
         
      } else if (request.data.action==ACTION_APK_REQUIRED) {
          
          opera.extension.tabs.create({url: apkUrl, focused:true});
          
      }
}
</script>
</head>
<body>
</body>
</html>
